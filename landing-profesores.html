<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduConnect - Panel del Profesor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff; /* Fondo blanco */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header-bg {
            background: linear-gradient(to right, #4c51bf, #6b46c1); /* Degradado púrpura-azul */
        }
        .sidebar {
            background: linear-gradient(to bottom, #4c51bf, #6b46c1); /* Degradado para la barra lateral */
            color: #e0e7ff; /* Texto azul muy claro */
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        .sidebar-link:hover {
            background-color: rgba(255, 255, 255, 0.2); /* Blanco transparente al pasar el ratón */
            color: #ffffff;
        }
        .sidebar-link.active {
            background-color: #a78bfa; /* Púrpura claro para el activo */
            color: #ffffff;
            font-weight: 600;
        }
        .main-content {
            flex-grow: 1;
            padding: 2.5rem; /* p-10 */
        }
        .main-section {
            display: none; /* Todas las secciones ocultas por defecto */
        }
        .main-section.active {
            display: block; /* La sección activa se muestra */
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            padding: 2rem; /* p-8 */
        }
        .recordatorio-item {
            background-color: #eef2ff; /* Azul muy claro para los recordatorios */
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #6b46c1; /* Borde púrpura para destacar */
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Para que el botón de eliminar se ajuste en móviles */
        }
        .recordatorio-item button {
            background-color: #dc2626; /* red-600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease-in-out;
            margin-top: 0.5rem; /* Espacio para móviles */
        }
        .recordatorio-item button:hover {
            background-color: #b91c1c; /* red-700 */
        }

        /* Estilos para el botón de cerrar sesión en la barra lateral */
        #logout-btn {
            background-color: #dc2626; /* red-600 */
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            margin-top: auto; /* Empuja el botón al fondo de la barra lateral */
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        #logout-btn:hover {
            background-color: #b91c1c; /* red-700 */
        }

        /* Estilos para el formulario de editarNotas (integrado) */
        .editar-notas-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151; /* gray-700 */
        }
        .editar-notas-form select,
        .editar-notas-form input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 1rem;
            box-sizing: border-box; /* Asegura que el padding no aumente el ancho total */
        }
        .editar-notas-form button {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .editar-notas-form button:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .editar-notas-form #mensaje {
            margin-top: 1rem;
            font-weight: 500;
            color: #4b5563; /* gray-600 */
        }


        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                flex-direction: row; /* En móvil, la sidebar puede ser horizontal */
                overflow-x: auto; /* Permite scroll horizontal si hay muchos enlaces */
                padding: 1rem;
            }
            .sidebar-link {
                white-space: nowrap; /* Evita que el texto del enlace se rompa */
            }
            .main-content {
                padding: 1.5rem;
            }
            #logout-btn {
                margin-top: 1rem; /* Ajuste para el margen en móvil */
                width: auto; /* Para que no ocupe todo el ancho si la sidebar es horizontal */
            }
            .recordatorio-item {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body class="antialiased">

    <div class="flex flex-col md:flex-row min-h-screen">

        <aside class="sidebar w-full md:w-64">
            <div class="text-3xl font-extrabold text-white mb-6 text-center">
                EduConnect
            </div>
            <nav class="flex flex-col gap-2">
                <a href="#" class="sidebar-link active" data-target="home-section">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <span>Inicio</span>
                </a>
                <a href="#" class="sidebar-link" data-target="recordatorios-section">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                    </svg>
                    <span>Recordatorios</span>
                </a>
                <a href="#" class="sidebar-link" data-target="notas-estudiantes-section">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                    <span>Notas Estudiantes</span>
                </a>
                </nav>
            <button id="logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                <span>Cerrar Sesión</span>
            </button>
        </aside>

        <main class="main-content flex-grow">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-6">
                Bienvenido, <span id="nombre-usuario" class="text-indigo-700 font-bold"></span>
            </h1>

            <section id="home-section" class="main-section active p-8 rounded-xl shadow-xl bg-white">
                <h2 class="text-3xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-indigo-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    Dashboard
                </h2>
                <p class="text-gray-700 text-lg mb-4">Aquí puedes ver un resumen de tu actividad como profesor.</p>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
                    <div class="card p-6 bg-blue-50 text-blue-800 flex items-center gap-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M12 20.354a4 4 0 110-5.292M12 14.354a4 4 0 100-5.292M12 4.354V20.354" />
                        </svg>
                        <div>
                            <p class="text-sm font-medium">Estudiantes Activos</p>
                            <p class="text-2xl font-bold">150</p>
                        </div>
                    </div>
                    <div class="card p-6 bg-green-50 text-green-800 flex items-center gap-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                        <div>
                            <p class="text-sm font-medium">Notas Actualizadas</p>
                            <p class="text-2xl font-bold">45</p>
                        </div>
                    </div>
                    <div class="card p-6 bg-purple-50 text-purple-800 flex items-center gap-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <div>
                            <p class="text-sm font-medium">Eventos Próximos</p>
                            <p class="text-2xl font-bold">7</p>
                        </div>
                    </div>
                </div>

                <section class="card mt-8">
                    <h3 class="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-indigo-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Anuncios Recientes
                    </h3>
                    <div class="space-y-4">
                        <div class="reminder-item">
                            <p class="font-bold text-gray-800">Recordatorio de Evaluación Final</p>
                            <p class="text-sm text-gray-600">Revisar las notas antes del <span class="font-medium text-purple-500">30 de Julio</span></p>
                        </div>
                        <div class="reminder-item">
                            <p class="font-bold text-gray-800">Aviso: Charla sobre Orientación Vocacional</p>
                            <p class="text-sm text-gray-600">Consejería Estudiantil - <span class="font-medium text-purple-500">Fecha: 25 de Julio, 3 PM</span></p>
                        </div>
                    </div>
                    <div class="text-center mt-8">
                        <a href="#" class="text-indigo-600 hover:text-indigo-800 font-semibold transition duration-300">
                            Ver todos los anuncios →
                        </a>
                    </div>
                </section>
            </section>

            <section id="recordatorios-section" class="main-section p-8 rounded-xl shadow-xl bg-white hidden">
                <h2 class="text-3xl font-bold text-gray-900 mb-6">Crear y Gestionar Recordatorios</h2>

                <form id="form-recordatorio" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <label for="materia" class="block text-gray-700 font-medium mb-2">Materia</label>
                        <select id="materia" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                            <option value="">Selecciona una materia</option>
                            <option value="Fisica">Física</option>
                            <option value="Quimica">Química</option>
                            <option value="Ciencias Sociales">Ciencias Sociales</option>
                            <option value="Economia y Politica">Economía y Política</option>
                            <option value="Artistica">Artística</option>
                            <option value="Etica y Religion">Ética y Religión</option>
                            <option value="Edu.Fisica">Educación Física</option>
                            <option value="Lenguaje">Lenguaje</option>
                            <option value="Ingles">Inglés</option>
                            <option value="Matematicas">Matemáticas</option>
                            <option value="Gestion Empresarial">Gestión Empresarial</option>
                            <option value="Tecnologia">Tecnología</option>
                            <option value="Filosofia">Filosofía</option>
                            <option value="Taller">Taller</option>
                            <option value="Convivencia">Convivencia</option>
                        </select>
                    </div>
                    <div>
                        <label for="fecha" class="block text-gray-700 font-medium mb-2">Fecha</label>
                        <input type="date" id="fecha" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required />
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label for="descripcion" class="block text-gray-700 font-medium mb-2">Descripción</label>
                        <textarea id="descripcion" rows="4" placeholder="Escribe la descripción del recordatorio..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required></textarea>
                    </div>
                    <div class="col-span-1 md:col-span-2 text-right">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                            Guardar Recordatorio
                        </button>
                    </div>
                </form>

                <h3 class="text-2xl font-bold text-gray-800 mb-4">Recordatorios Guardados</h3>
                <div id="lista-recordatorios" class="space-y-4">
                    <!-- Aquí se cargarán los recordatorios desde Supabase -->
                </div>
            </section>

            <section id="notas-estudiantes-section" class="main-section p-8 rounded-xl shadow-xl bg-white hidden">
                <h2 class="text-3xl font-bold text-gray-900 mb-6">Modificar Notas de Estudiantes</h2>

                <div class="editar-notas-form">
                    <label for="estudiante">Estudiante:</label>
                    <select id="estudiante" required>
                      <option value="" disabled selected>Seleccione un estudiante</option>
                    </select>

                    <label for="asignatura">Asignatura:</label>
                    <select id="asignatura" required>
                      <option value="" disabled selected>Seleccione una asignatura</option>
                    </select>

                    <label for="nuevaNota">Nueva Nota:</label>
                    <select id="nuevaNota" required>
                      <option value="" disabled selected>Seleccione una nota</option>
                      <option value="DBJ">DBJ</option>
                      <option value="DB">DB</option>
                      <option value="DA">DA</option>
                      <option value="DS">DS</option>
                    </select>

                    <button id="btnActualizar" type="button">Actualizar Nota</button>
                    <p id="mensaje"></p>
                </div>
            </section>

        </main>

    </div>

    <footer class="bg-gray-900 text-white py-8 px-4 rounded-t-xl mt-auto">
        <div class="container mx-auto text-center text-sm">
            <p>&copy; 2025 EduConnect. Todos los derechos reservados.</p>
            <div class="mt-4 flex flex-wrap justify-center gap-x-6 gap-y-2">
                <a href="#" class="text-gray-400 hover:text-white transition duration-300">Política de Privacidad</a>
                <span class="text-gray-600">|</span>
                <a href="#" class="text-gray-400 hover:text-white transition duration-300">Términos de Servicio</a>
                <span class="text-gray-600">|</span>
                <a href="#" class="text-gray-400 hover:text-white transition duration-300">Ayuda</a>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            console.log("landing-profesores.html DOM cargado");

            // --- REDIRECCIÓN SI NO HAY SESIÓN DE PROFESOR ---
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            const userRole = localStorage.getItem("userRole");

            if (!currentUser || userRole !== "profesor") {
                alert("Acceso denegado. Por favor, inicia sesión como profesor.");
                window.location.href = "login-profesores.html"; // Redirige a la página de login de profesores
                return; // Detiene la ejecución del resto del script
            }

            // --- Supabase initialization (for recordatorios and existing notes logic) ---
            // Reemplaza 'TU_URL_DE_PROYECTO_SUPABASE' y 'TU_CLAVE_ANON_SUPABASE' con tus credenciales reales.
            const SUPABASE_URL = 'https://aamvnpvfzmnrrfurovuv.supabase.co'; // <-- ¡IMPORTANTE! Reemplaza con tu URL
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhbXZucHZmem1ucnJmdXJvdnV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwNjI2NDUsImV4cCI6MjA2MzYzODY0NX0._OigReH-zPR9AfGE5L9Rw9H71AnxQzH7T5k93mjPj5E'; // <-- ¡IMPORTANTE! Reemplaza con tu clave ANÓNIMA
            
            let supabase; // Declara la variable para Supabase
            try {
                // Añadimos console.log para verificar los valores antes de la inicialización
                console.log('Intentando inicializar Supabase con URL:', SUPABASE_URL);
                console.log('Intentando inicializar Supabase con KEY (primeros 5 chars):', SUPABASE_ANON_KEY.substring(0, 5) + '...');
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase inicializado con éxito.');

                // --- NUEVA PRUEBA DE CONEXIÓN BÁSICA ---
                // Esta prueba intentará leer un solo 'id' de la tabla 'recordatorios'.
                // Si falla con 401, el problema es en las políticas de RLS para SELECT.
                (async () => {
                    try {
                        const { data, error } = await supabase.from('recordatorios').select('id').limit(1);
                        if (error) {
                            console.error('ERROR en prueba de conexión básica (SELECT):', error);
                            // Si el error es 401, sugiere que la política 'SELECT' no está permitiendo el acceso.
                            if (error.code === '401') {
                                console.error('Posible problema de RLS: La política de SELECT podría no permitir el acceso con la clave anónima.');
                            }
                        } else {
                            console.log('Prueba de conexión básica (SELECT) exitosa. Datos:', data);
                        }
                    } catch (e) {
                        console.error('ERROR inesperado en prueba de conexión básica (SELECT):', e);
                    }
                })();
                // --- FIN DE PRUEBA ---

            } catch (e) {
                console.error('ERROR: Fallo al inicializar Supabase. Verifica tu URL y clave.', e);
                alert('Hubo un problema al conectar con la base de datos. Por favor, verifica la configuración.');
                // Si Supabase no se inicializa, las funciones que dependen de él no funcionarán.
                // Podrías deshabilitar los formularios o botones si esto es crítico.
            }


            // --- Mostrar nombre del profesor ---
            const nombreUsuarioSpan = document.getElementById("nombre-usuario");
            if (currentUser && currentUser.nombre) {
                nombreUsuarioSpan.textContent = currentUser.nombre;
            } else {
                nombreUsuarioSpan.textContent = "Profesor"; // Valor por defecto si no hay nombre
            }

            // --- Lógica de la Sidebar y navegación entre secciones ---
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const mainSections = document.querySelectorAll('.main-section');
            const allNavigableElements = document.querySelectorAll('[data-target]');

            // Función para ocultar todas las secciones
            const hideAllSections = () => {
                mainSections.forEach(section => {
                    section.classList.remove('active');
                    section.style.display = 'none'; // Asegurar que estén ocultas
                });
            };

            // Función para desactivar todos los enlaces de la barra lateral
            const deactivateAllLinks = () => {
                sidebarLinks.forEach(link => {
                    link.classList.remove('active');
                });
            };

            // Event listener for all navigable elements (sidebar links)
            allNavigableElements.forEach(element => {
                element.addEventListener('click', (e) => {
                    e.preventDefault(); // Prevent default link behavior

                    const targetId = element.dataset.target; // Get the ID of the target section
                    const targetSection = document.getElementById(targetId);

                    console.log('Clic en elemento de navegación:', element.textContent.trim());
                    console.log('ID de sección objetivo:', targetId);

                    if (targetSection) {
                        console.log('Sección objetivo encontrada:', targetId);
                        hideAllSections(); // Hide all sections
                        deactivateAllLinks(); // Deactivate all sidebar links

                        targetSection.classList.add('active'); // Show the target section
                        targetSection.style.display = 'block'; // Asegurar que se muestre
                        console.log('Sección ahora visible:', targetId);

                        // Find and activate the corresponding sidebar link
                        sidebarLinks.forEach(sidebarLink => {
                            if (sidebarLink.dataset.target === targetId) {
                                sidebarLink.classList.add('active');
                                console.log('Enlace de sidebar activado:', sidebarLink.textContent.trim());
                            }
                        });

                        // Si la sección de recordatorios se activa, cargar los recordatorios
                        if (targetId === 'recordatorios-section') {
                            console.log('Cargando recordatorios...');
                            // Solo llama a mostrarRecordatorios si Supabase está inicializado
                            if (supabase) {
                                mostrarRecordatorios(); 
                            } else {
                                console.error('Supabase no está inicializado, no se pueden cargar los recordatorios.');
                            }
                        }
                        // Si la sección de notas de estudiantes se activa, cargar los datos de edición de notas
                        if (targetId === 'notas-estudiantes-section') {
                            console.log('Cargando datos de edición de notas...');
                            // Solo llama a cargarDatosEditarNotas si Supabase está inicializado
                            if (supabase) {
                                cargarDatosEditarNotas();
                            } else {
                                console.error('Supabase no está inicializado, no se pueden cargar las notas de estudiantes.');
                            }
                        }
                    } else {
                        console.error('ERROR: Sección objetivo NO encontrada para ID:', targetId);
                    }
                });
            });

            // Mostrar la sección de Inicio por defecto al cargar la página
            hideAllSections();
            const homeSection = document.getElementById('home-section');
            if (homeSection) {
                homeSection.classList.add('active');
                homeSection.style.display = 'block';
            }
            const homeSidebarLink = document.querySelector('.sidebar-link[data-target="home-section"]');
            if (homeSidebarLink) {
                homeSidebarLink.classList.add('active');
            }


            // --- Lógica de Recordatorios (integrada) ---
            const formRecordatorio = document.getElementById("form-recordatorio");
            const listaRecordatorios = document.getElementById("lista-recordatorios");

            /**
             * Obtiene todos los recordatorios desde la tabla 'recordatorios' en Supabase.
             * @returns {Array} Un array de objetos recordatorio.
             */
            async function obtenerRecordatoriosDesdeSupabase() {
              if (!supabase) { // Asegura que Supabase esté inicializado
                  console.error('Supabase no está inicializado para obtener recordatorios.');
                  return [];
              }
              const { data, error } = await supabase
                .from('recordatorios')
                .select('*')
                .order('fecha', { ascending: true }); // Opcional: ordenar por fecha

              if (error) {
                console.error('Error al obtener recordatorios de Supabase:', error);
                alert('Hubo un error al cargar los recordatorios. Por favor, inténtalo de nuevo más tarde.');
                return [];
              }
              return data;
            }

            /**
             * Guarda un nuevo recordatorio en la tabla 'recordatorios' de Supabase.
             * Incluye el 'codigo_profesor' del usuario logueado para vincular el recordatorio.
             * @param {string} materia - La materia del recordatorio.
             * @param {string} fecha - La fecha del recordatorio (formato YYYY-MM-DD).
             * @param {string} descripcion - La descripción del recordatorio.
             * @returns {Object|null} El objeto del recordatorio insertado o null si hay un error.
             */
            async function guardarRecordatorioEnSupabase(materia, fecha, descripcion) {
              if (!supabase) { // Asegura que Supabase esté inicializado
                  console.error('Supabase no está inicializado para guardar recordatorios.');
                  return null;
              }
              const currentUserData = JSON.parse(localStorage.getItem("currentUser"));
              const profesorCodigo = currentUserData ? currentUserData.codigo_profesor : null;

              if (!profesorCodigo) {
                alert("Error: No se pudo identificar al profesor. Por favor, inicie sesión correctamente.");
                window.location.href = "login-profesores.html";
                return null;
              }

              const { data, error } = await supabase
                .from('recordatorios')
                .insert({
                  materia: materia,
                  fecha: fecha,
                  descripcion: descripcion,
                  profesor_creador_codigo: profesorCodigo
                })
                .select();

              if (error) {
                console.error('Error al guardar recordatorio en Supabase:', error);
                alert('Hubo un error al guardar el recordatorio. Por favor, inténtalo de nuevo.');
                return null;
              }
              console.log('Recordatorio guardado:', data);
              return data[0];
            }

            /**
             * Elimina un recordatorio de la tabla 'recordatorios' en Supabase.
             * @param {string} recordatorioId - El ID único (UUID) del recordatorio a eliminar.
             */
            async function eliminarRecordatorioDesdeSupabase(recordatorioId) {
              if (!supabase) { // Asegura que Supabase esté inicializado
                  console.error('Supabase no está inicializado para eliminar recordatorios.');
                  return;
              }
              const currentUserData = JSON.parse(localStorage.getItem("currentUser"));
              const profesorCodigo = currentUserData ? currentUserData.codigo_profesor : null;

              if (!profesorCodigo) {
                alert("Error: No se pudo identificar al profesor para eliminar el recordatorio.");
                window.location.href = "login-profesores.html";
                return;
              }

              try {
                // 1. Llama a la función de base de datos para establecer el código del profesor en la sesión.
                const { error: rpcError } = await supabase.rpc('set_profesor_codigo', { p_codigo: profesorCodigo });
                if (rpcError) {
                  throw new Error('Error al establecer el contexto del profesor: ' + rpcError.message);
                }

                // 2. Ejecuta la operación de eliminación.
                const { error } = await supabase
                  .from('recordatorios')
                  .delete()
                  .eq('id', recordatorioId);

                if (error) {
                  console.error('Error al eliminar recordatorio en Supabase:', error);
                  alert('Hubo un error al eliminar el recordatorio o no tienes permiso para eliminarlo.');
                  return;
                }
                console.log('Recordatorio eliminado con éxito.');
                await mostrarRecordatorios();
              } catch (error) {
                console.error('Ocurrió un error inesperado al intentar eliminar el recordatorio:', error);
                alert('Ocurrió un error inesperado al intentar eliminar el recordatorio.');
              }
            }

            /**
             * Muestra los recordatorios en la lista de la página del profesor.
             */
            async function mostrarRecordatorios() {
                const recordatorios = await obtenerRecordatoriosDesdeSupabase();

                if (listaRecordatorios) { // Asegura que el elemento exista
                    if (recordatorios.length === 0) {
                        listaRecordatorios.innerHTML = "<p class='text-gray-600'>No hay recordatorios guardados.</p>";
                        return;
                    }

                    listaRecordatorios.innerHTML = "";
                    recordatorios.forEach((r) => {
                        const div = document.createElement("div");
                        div.className = "recordatorio-item";
                        div.innerHTML = `
                            <div>
                                <p class="font-bold text-gray-800">Materia: <span class="text-indigo-700">${r.materia}</span></p>
                                <p class="text-sm text-gray-600">Fecha: <span class="font-medium text-purple-500">${r.fecha}</span></p>
                                <p class="text-sm text-gray-700 mt-1">Descripción: ${r.descripcion}</p>
                            </div>
                            <button data-id="${r.id}">Eliminar</button>
                        `;
                        listaRecordatorios.appendChild(div);
                    });

                    listaRecordatorios.querySelectorAll("button[data-id]").forEach(btn => {
                        btn.addEventListener("click", (e) => {
                            const recordatorioId = e.target.getAttribute("data-id");
                            eliminarRecordatorioDesdeSupabase(recordatorioId);
                        });
                    });
                }
            }

            // Manejar el envío del formulario para guardar un nuevo recordatorio
            if (formRecordatorio) {
                formRecordatorio.addEventListener("submit", async (e) => {
                    e.preventDefault();

                    const materia = formRecordatorio.materia.value.trim();
                    const fecha = formRecordatorio.fecha.value;
                    const descripcion = formRecordatorio.descripcion.value.trim();

                    if (!materia || !fecha || !descripcion) {
                        alert("Por favor completa todos los campos.");
                        return;
                    }

                    await guardarRecordatorioEnSupabase(materia, fecha, descripcion);
                    formRecordatorio.reset();
                    await mostrarRecordatorios();
                });
            }


            // --- Lógica de editarNotas.js para Modificar Notas (EXISTENTE) ---
            const selectEstudiante = document.getElementById('estudiante');
            const selectAsignatura = document.getElementById('asignatura');
            const btnActualizar = document.getElementById('btnActualizar');
            const mensajeNotas = document.getElementById('mensaje');
            const nuevaNotaInput = document.getElementById('nuevaNota');

            async function cargarDatosEditarNotas() {
                if (!supabase) { // Asegura que Supabase esté inicializado
                    console.error('Supabase no está inicializado para cargar datos de notas.');
                    return;
                }
                try {
                    const { data: estudiantes, error: errEst } = await supabase
                      .from('estudiantes')
                      .select('id, nombre, correo');
                    if (errEst) throw errEst;

                    if (selectEstudiante) { // Asegura que el elemento exista
                        selectEstudiante.innerHTML = '<option value="" disabled selected>Seleccione un estudiante</option>';
                        estudiantes.forEach(est => {
                          const option = document.createElement('option');
                          option.value = est.id;
                          option.textContent = est.nombre;
                          selectEstudiante.appendChild(option);
                        });
                    }


                    const { data: materias, error: errMat } = await supabase
                      .from('materias')
                      .select('id, nombre');
                    if (errMat) throw errMat;

                    if (selectAsignatura) { // Asegura que el elemento exista
                        selectAsignatura.innerHTML = '<option value="" disabled selected>Seleccione una asignatura</option>';
                        materias.forEach(mat => {
                          const option = document.createElement('option');
                          option.value = mat.id;
                          option.textContent = mat.nombre;
                          selectAsignatura.appendChild(option);
                        });
                    }

                } catch (error) {
                    if (mensajeNotas) { // Asegura que el elemento exista
                        mensajeNotas.textContent = 'Error al cargar estudiantes o materias: ' + error.message;
                    }
                }
            }

            if (btnActualizar) {
                btnActualizar.addEventListener('click', async () => {
                    if (!supabase) { // Asegura que Supabase esté inicializado
                        console.error('Supabase no está inicializado para actualizar notas.');
                        if (mensajeNotas) mensajeNotas.textContent = 'Error: Conexión a la base de datos no disponible.';
                        return;
                    }
                    const estudianteId = selectEstudiante.value;
                    const materiaId = selectAsignatura.value;
                    const nuevaNota = nuevaNotaInput.value.trim().toUpperCase();

                    if (!estudianteId || !materiaId || !nuevaNota) {
                      if (mensajeNotas) mensajeNotas.textContent = 'Por favor, complete todos los campos.';
                      return;
                    }

                    const notasValidas = ['DBJ', 'DB', 'DA', 'DS'];
                    if (!notasValidas.includes(nuevaNota)) {
                      if (mensajeNotas) mensajeNotas.textContent = 'La nota debe ser DBJ, DB, DA o DS.';
                      return;
                    }

                    try {
                      const { data: notaExistente, error: errBuscar } = await supabase
                        .from('notas')
                        .select('id')
                        .eq('estudiante_id', estudianteId)
                        .eq('materia_id', materiaId)
                        .single();

                      if (errBuscar && errBuscar.code !== 'PGRST116') { // PGRST116 es "No rows found"
                        throw errBuscar;
                      }

                      if (notaExistente) {
                        const { error: errActualizar } = await supabase
                          .from('notas')
                          .update({ nota: nuevaNota })
                          .eq('id', notaExistente.id);
                        if (errActualizar) throw errActualizar;

                        if (mensajeNotas) mensajeNotas.textContent = 'Nota actualizada correctamente.';
                      } else {
                        const { error: errInsertar } = await supabase
                          .from('notas')
                          .insert([{ estudiante_id: estudianteId, materia_id: materiaId, nota: nuevaNota }]);
                        if (errInsertar) throw errInsertar;

                        if (mensajeNotas) mensajeNotas.textContent = 'Nota agregada correctamente.';
                      }

                      setTimeout(() => { if (mensajeNotas) mensajeNotas.textContent = ''; }, 4000);

                    } catch (error) {
                      if (mensajeNotas) mensajeNotas.textContent = 'Error al actualizar nota: ' + error.message;
                    }
                });
            }

            const notasEstudiantesSection = document.getElementById('notas-estudiantes-section');
            const observer = new MutationObserver((mutationsList) => {
                for (const mutation of mutationsList) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        if (notasEstudiantesSection && notasEstudiantesSection.classList.contains('active')) {
                            cargarDatosEditarNotas();
                        }
                    }
                }
            });
            if (notasEstudiantesSection) { // Asegura que el elemento exista antes de observar
                observer.observe(notasEstudiantesSection, { attributes: true });
            }


            // --- Lógica de Cerrar Sesión (EXISTENTE) ---
            const logoutBtn = document.getElementById("logout-btn");
            if (logoutBtn) {
                logoutBtn.addEventListener("click", () => {
                    localStorage.removeItem("currentUser");
                    localStorage.removeItem("userRole");
                    localStorage.removeItem("userName");
                    window.location.href = "login-profesores.html";
                });
            }
        });
    </script>
</body>
</html>
